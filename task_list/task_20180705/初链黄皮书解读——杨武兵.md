# 介绍
本文将聚焦解读初链的共识部分内容。随着比特币的价格不断攀升，让工业和学术届都开始关注到了区块链技术。而当前区块链技术若想大规模广泛应用于商业场景，基础设施还存在着巨大的缺陷，就是当前基于PoW共识的效率太低，例如当前基于PoW共识的比特币不足10tps；而改进的一些共识算法虽然可以解决效率问题，但又带来其了伪去中心化的问题，节点还是被某些少数的组织控制，失去了区块链可信任的最大价值。
初链团队最早聚焦于数字广告行业，该行业对于底层区块链的性能要求更高，而他们发现业界还没有很好的解决方案，因此提出了基于混合共识改进的初链解决方案，希望初链能够获得高兴性和去中心化的特性，可大规模广泛应用于数字广告、金融、保险等不同的商业场景。

# 混合共识介绍
Pass和Shi在2017年发表关于混合共识算法的论文——《R. Pass and E. Shi. Hybrid consensus: Efficient consensus in the permissionless model. In LIPIcs-Leibniz International Proceedings in Informatics, volume 91. Schloss Dagstuhl-Leibniz-Zentrum fuer Informatik, 2017》。初链的共识算法理论基础是来源于该论文，若想彻底了解初链的混合共识，应该从该论文出发。
该论文提出了混合共识的方案。接下来详细讲解一下该论文的混合共识方案。
## 混合共识概述
论文提出的方案是结合传统（有权限控制）和区块链式（无权限控制）共识形成混合的共识机制。
高层概览，它运行一个底层区块链协议，暂时表示为—蜗牛链。假设我们运行“中本聪”区块链作为蜗牛链。随着时间的推移我们依赖区块链重新选举委员会，而委员会由最近在线的“矿工”组成。每一届委员会将会运行一个传统的、半同步共识协议实例（例如PBFT)，后面用“每日共识”来代称，用它来进行交易确认。
为了周期性的选举委员会，可以这样做：每当区块链前进λ个区块，就重新开始选举委员会，用如下方式来进行重新选举：
1. 首先去除尾部不稳定的的Θ(λ)个区块。
2. 剩下的区块链中选择最新的λ个区块的矿工作为新的委员会成员。

考虑了以下关键点：
- 由于区块链的一致性，只要我们去掉尾部Θ(λ)块,除了概率可以忽略不计,所有节点将同意委员会——为此,删除后Θ(λ)块很重要,而之前的工作,忽视了这个情况可能会导致不一致。
- 如果底层区块链满足2/3链质量,然后每个窗口的连续λ个区块在一个诚实节点的链中，至少有2/3部分的区块由诚实节点贡献。
- 最后，由于链的增长不需要花费太长时间就可以选举新的委员会。

## 混合共识详解
接下来介绍混合共识协议的详细过程。首先定义一个所有协议实例共享的签名函数Gsign，该函数提供如下接口：
1. 当接收到节点i发出的keygen命令，则调用key生成器生成一对新的非对称密钥对(sk,pk)，并且返回pk的值。
2. 当接收到节点i发出的mykeys命令，则输出所有为节点i生成的公钥pk列表。
3. 当接收到节点i发出的sign(pk, msg) 命令，调用Σ.Sign(sk, (sid, msg))函数，sid是当前会话标识，而sk是和pk相对应的私钥，最后再返回签名值。
4. 一旦节点i腐败了，则返回节点i的所有私钥给A.

### 离链BFT协议
BFT委员会的服务任期为一天。考虑到协议的模块设计，定义一个中间的抽象称为每日离链共识协议，用每日BFT来表示。在该协议中，委员会成员会运行一个离链BFT实例来决定每日日志，而非成员则会从成员计算签名，一个每日BFT[R]有R来参数化，R是会话标识，它代表了某一天，该协议有以下句法：
#### 输入和输出
在每一个时间步长，环境Z会提供多次如下输入类型：
1. 命令start(comm)，其中 comm = {pki}i∈[m]，comm就是委员会成员的公钥集合，发送启动BFT实例的命令。
2. TXs。确认的交易日志，通过BFT协议对交易进行确认。
3. stop。停止BFT实例。
诚实的节点会向环境Z输出如下内容：
- 每隔时间步长t,诚实节点会向环境Z输出notdone(logt)确认的交易日志，直到最后一步t∗,它输出了done(logt∗,recs),而recs要么是空集合∅，要么是一组有符号的元祖，以保证每日日志的散列，一旦输出了done(logt∗ , recs)，则诚实节点就会停止向环境输出内容。

#### 实现 
每日BFT协议的实现概览如下：
- BFT虚拟机节点和委员会选择性开放。一旦每日BFT接收到start(comm) ，如果comm中包含了一个或多个当前节点的公钥，则当前节点被选为成员，这种情况下，该节点就会它的每一个在comm中的公钥分裂出一个虚拟节点，这样委员会就由环境Z通过命令start(comm)选择性的开放了。
- 成员和非成员的基本操作。委员会成员依靠BFT协议填充它们的每日日志；而委员会非成员则通过委员会成员的签名来填充他们的日志。
- 终止。节点按照如下步骤来实现终止过程：一旦一个诚实的委员会成员节点接收到stop指令，它会输入一个特殊带签名的stop交易给它的每一个虚拟BFT节点。而只要内部的BFT实例输出了包含stop交易的日志，而且至少该交易至少被1/3的comm中不相同的公钥签名过，该日志就结束了，最后被输出。所有位于stop交易之后的交易都会被忽略掉。
- 签署每日日志散列值。当委员会成员输出done结束标志，它们还输出最终日志的签名摘要。而下面的混合共识协议会把这个摘要标记到蜗牛链上去。

### 混合共识协议
接下来描述建立在区块链协议之上的混合共识协议，标记为“蜗牛链”。混合共识的描述依赖于实现了抽象区块链定义的任意协议，为了简化概念，可以将蜗牛链理解为中本聪的初始区块链协议，而实际上，混合共识是以插件的形式用“水果链”替代了“中本聪”链，因为水果链具有接近最有的链质量，因此产生的混合一致协议(用水果链实例化)将具有接近最优的恢复能力。

混合共识实用了每日BFT协议的多实例，其中轮转的委员会对每日日志达成一致。混合共识主要做以下工作:
- 它使用蜗牛链作为全局时钟，有效地管理每日BFT实例的生成和终止，在诚实的节点之间提供弱同步。
- 回想一下，每个每日BFT实例都不能保证生成太晚的节点的安全性，因为委员会成员可能在将来很长一段时间内变得腐败，那时它们可以签名任意的元组。因此，混合共识引入了链上冲压机制，将安全性保证扩展到延迟生成的节点。

论文中图2详细描述了混合共识的算法过程，本文暂时忽略，可参考原论文。每个节点都维护了所有之前的交易日志，标记为“历史”，算法描述为了描述简单，做了很多简化，只是理论上的，在实际实现中会进行很多优化。新生成的节点会快速获取历史的交易日志（实际上诚实节点会提供历史恢复服务），当一个节点产生后，它会按照如下步骤填充历史日志：

- 匹配链上合法元组。一个新生成的节点首先会以(R,h)的形式来标识所有链上合法元祖，其中R是天数，而h是每日日志的散列值，然后该节点会查找历史，找出每日日志logR的散列值和h相同的日志，节点就会用这些每日日志来填充它自己的日志LOG，这种链上的匹配过程有效地为新生成的节点提供了一种安全的机制，以便赶上并填充其输出日志的旧条目。
- 通过每日离链共识。一旦这个追赶过程完成，节点将从此以后依赖每日BFT实例来进一步填充其输出日志的其余条目。在每个每日BFT实例中，节点可以作为委员会成员或非成员。


# 初链的混合共识
初链的混合共识就是在Pass和Shi混合共识论文基础上做了一些改进形成的。所以混合共识的其它部分内容参考论文内容，接下来只介绍以下初链针混合共识的改进内容。

## 委员会选举的改进
初链针对委员会选举的算法规则做了大量的改进，具体规则包括：
- 在论文中，BFT委员会的实例每隔固定时间（以蜗牛链作为逻辑时钟，例如每隔n个区块）进行切换，新的委员会由这些区块对应的矿工组成。而初链的设计是如果委员会表现良好，就不会强制进行切换，某些场合下这样可以避免切换带来的高开销；
- 而另外一方面，如果委员会表现良好，则会增加新的矿工成为委员会成员的难度，这样就丧失了公平性，该公链的可信度会下降，因此又保留了定期切换委员会成员的设计，但是切换频率会低得多，委员会成员每隔K天切换一次，足够低得频率能够降低切换成本。
- 初链还提出了Thunderella认证投诉的方案，蜗牛链可作为BFT委员会犯错得证据，也就是说当从蜗牛链中检测到不正当得行为时，则第二天得起点就会强制切换。
- 更进一步，初链还替换了委员会成员选择标准，论文描述从蜗牛链中最近的区块中挑选矿工，而初链选择委员会成员基于混合标准的股份和随机性，更具体地说，它允许全节点提出特殊的stake_in和stake_out交易，以暂时冻结他们的通证资产，并且每当一个委员会切换发生时，我们将根据他们的冻结股份选择θ.csize的账户，其中θ∈[0,1]是一个手动参数。
- 在论文《Algorand: Scaling byzantine agreements for cryptocurrencies》的设计基础上，初链根据VRF（Vadhan. Verifiable random functions. ）的结果，选择(1-θ).csize节点，其中种子是由先前委员会选择中使用的种子来确定的，以及从最近的csize区块中提出的随机性。与Algorand不同，这里不计算选择部分的股权值。 

经过初链对于混合共识中的BFT委员会选举算法的大量改进，使得选举的频率更低，切换成本低，同时增加了监督机制，对于恶意的节点及时进行惩罚，同时又增加了随机性，增加了委员会选举的公平性，降低了选举被操控的可能性。
