# 初链黄皮书个人解析

# 前言：

 如今公链当前面临的最大问题是安全和效率的矛盾，即如何在去中心化程度和高TPS两者之间取得平衡，最典型的代表如以太坊和EOS之争，BM批评以太坊网络拥堵，Vitalik批评EOS只有21个节点，节点少速度快当然容易。
 
 EOS没有以太坊安全可靠，以太坊有10000个节点，攻击21个节点比攻击10000个节点容易得多。

 以太坊没有EOS效率高，以前EOS的宣传卖点主要是每秒能处理百万级交易量，不过前段时间改口了，只剩数千TPS，但也比以太坊速度高100倍了。

# 初链的混合共识

 开源公链要解决的最关键问题是如何在去中心化和效率之间找到平衡，这不仅比拼技术，更考验系统整体设计能力。我们看看初链黄皮书


## 混合共识fPOW/pow+BPFT

 单一共识已经无法找到效率和安全的平衡点，初链作为高性能去中心化的公开账本，使用PBFT和fPOW混合共识的设计模式来尽可能偏向那个平衡点，fPOW共识确保了激励和委员会的选择，PBFT层作为一种高效的共识，如快速的终结性，高通量，交易验证，公平贸易经济的轮值委员会，以及处理非统一基础设施的补偿基础设施，混合协议的本质允许它最大限度地容忍大约三分之一的对等节点的腐败。

 

#### 我们先再看看什么是fPOW？

  fPOW是初链将“水果链”(Fruitchain)技术整合到原来混合共识底层的PoW技术,由原来的PoW变成了fPoW，那为什么要这么做？   
  因为POW并不是完美的，比如中本聪的比特币一开始采用的POW挖矿模式，现在大部分算力都由几大矿场保持，若几大矿场联合分叉比特币，那普通用户手中的比特币也将一文不值。   
  POW目前遇到了几个问题：

   - 联合挖矿(矿池)
   - 自私挖矿者攻击(Selfish Mining Attack - 即25%攻击)
       
	事实证明,一组控制了25%算力的节点,可以获得超过33%的区块奖励。在混合共识中,25%攻击还可能导致PBFT委员会中超过1/3节点控制在同一批矿工的手中。更加现实的情况是,在以太坊类型的区块链中,一个控制了40%算力的矿工可以收获70%的区块奖励。
   
   - 不稳定交易费：当网络拥堵时交易费越高则越快被打包
       
   因此传统PoW的挖矿就会逐步趋于中心化!

   结合目前市场上已有算力的情况,TrueChain设计并改进了fPoW,将其作为TrueChain底层SnailChain的协议。根据TrueChain的黄皮书,在fPoW挖矿的过程中,将有以下特点:

   - 1.能抵制联合挖矿
	
	水果(Fruits)比区块(Blocks)挖矿难度低, 普通挖矿,个人平均两年才能挖到一个矿,但水果却一天可以挖到两个,这样矿工形成的矿池的动力就变小了,从而抵制了联合挖矿,使得PoW更加公平。
	
   - 2.能抵制自私挖矿
	
	水果在被写入区块前都不稳定,而且存在一定的保质期,算法规定包含最多水果的块为主链,所以矿工挖矿需要尽快将水果收到区块里,而不能默不作声地等着浪费别人的算力,从而抵制了自私挖矿; 而矿工将水果收入会先得到挖矿奖励,再将一定奖励分发给包涵进区块的水果。
	
   - 3.乱序挖矿
	
	fPoW协议使得水果的挖矿顺序可以为任意顺序,即可以并行挖矿,在Sharding中非常有用。

#### 我们再看看初链的共识机制大概怎么运行

  一般情况下初链的共识机制默认采用BFT协议，因为此协议能快速处理大量交易。BFT委员会的委员每隔一段固定时间进行切换，新的委员会会由矿工们组成，因此只有挖矿的人才有可能获得成为委员的机会。

  初链的共识设计中，如果委员会的委员表现良好，就不必强迫他们轮换，因为交换委员会又是一笔开销，试想，如果一个节点是诚实节点，就没有必要时不时的选举新的节点。另一方面，如果前一个委员会保持良好的记录，这将增加新节点当选为委员会成员的难度，导致不公平，中心化产生，因此初链在超出一定时间后，强制切换委员会的委员。委员会成员是从最近的Snailchain区块的矿工中挑选出来的，而决定选择委员会成员是基于混合标准的股份和随机性。

# 初链的分片方案

初链对原始混合共识的一个重要修改是，为其添加了计算和数据分片支持，设计了一个基于分片的投机交易处理系统。在混合共识中，DailyBFT实例被索引为一个确定性序列，允许同时存在多个DailyBFT实例序列。准确地说，通过分片表示DailyDFT序列，并且将分片的数量固定为一个数，每一个DailyBFT是一个普通的分片，除了普通分片，有一个由csize节点组成的主分片。主分片的工作是最后确定正常分片输出的顺序，以及在分布式事务处理系统中实现协调器。而普通的分片不是直接连接到混合协商一致组件，而是将日志提交给主分片，然后主分片与混合共识进行对话。

对于主分片，其收集普通分片的输出。注意，交易的数据依赖可以轻易的从它们的元数据里推导。事实上，一个交易如果用到多个远程分片，它会在所有参与的分片上留下痕迹。当普通分片提交日志给主分片时，同时会写到Snailchain上。


# 初链的虚拟机（TVM）和智能合约

初链在超级账本的Fabric框架的启发下想将虚拟机替换成容器，那要将Fabric的权限化的性质改成去权限化的话，那面临的第一个挑战就是解决chaincode的问题，虽然可以将一个chaincode或智能合约放在一个容器里，但这对公链来说不是一个可扩展的模型，采用这种模型意味着公链的一个节点可能有几千个容器对应运行在其上的几千个智能合约（因为每个节点都维护一份拷贝），社区已经有人尝试限制运行在一个节点上面的最多容器数。这个限额目前是一个节点100个pod。如果要扩展容器，大家一般倾向于水平扩展而不是垂直扩展，这是因为后者极大地增加了设计决策的复杂度。由于完全取决于工作负载，并没有一个适合所有人尺寸的集群扩展配置规则，对于True这样的分布式网络则更为复杂。因此，初链依然选择EVM的设计，但做一些小的改动。

初链基础架构将整合EVM和类似EVM字节码执行引擎来运行智能合约，会使用一个虚拟机来处理POW共识，另外一个虚拟机处理PBFT共识，都集成在全节点，因此它们可以处理按需调用

# 初链的数据存储

Truechain上的数据存储分为三个级别：

 - 级别1：存储在每个PoW节点上，比如以太坊。 这是最永久的存储方式，也是效率最低的方式。初链不建议存储短文本以外的任何内容。
 
 - 级别2：将会有类似IPFS的文件系统将数据的有限副本分发给整个链中的存储节点。通常用于存储分布式应用程序以在True虚拟机上运行。用户将向矿工支付存储和检索费用。
 
 - 等级3：本地存储。该文件将只存储在您自己的本地节点。这对于点对点通信很有用，例如聊天程序，用户更关注没有人窃听。这是免费的。

# 初链的补偿机制

初链提出补偿机制的概念，以平衡BFT委员会成员和非成员完整节点的工作量。初链黄皮书提到：根据网络带宽、CPU为标准对所有片区一视同仁将导致倾斜性结果，如不一致的TPS，或者更严重的是有时超过了超时限制，因为交易的顺序是由主片决定的。为了处理这个问题，我们建议的奖励基础设施。至于补偿机制的细则还未出，期待下一版本的黄皮书明确列出。


# 初链黄皮书提到的优化方向：

 - 改进所有节点的时间戳同步，而不需要中心化的NTP服务器。
 - 喜欢奖励基础设施里的激励技术，这样重度投资基础设施的投资人不会遭遇“被忽视”，“亏本”的问题。
 - 支持副本创建的分片技术，尽量减少被BFT会员会拒绝的交易集。 
 - 添加零知识证明以增强隐私。
 - EVM、TVM和Linux容器技术的混合基础设施。
 - 改进虚拟机规范中的二进制数据编码方法，交易签名，收费表等章节。

# 个人建议：

 - 当节点处理的交易数据量过多时数据就会爆棚，为了存储所有这些数据，就必须找到好的存储方案。当数据维护成本大于所获利润就失去了大众矿工挖矿的动力，最终轮落到大矿场手中，中心化再所难免。
