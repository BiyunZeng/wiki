
# 前言
大家好，我今天分享的题目是《详解PoW+PBFT混合共识及优势》。在讲之前，让我们来先简单回顾一下2个概念。

# PoW简单介绍
## 什么是PoW共识呢？
PoW大家应该都不陌生，就是比特币的经典共识算法。中文翻译为工作量证明，通过不停地循环生成随机数并进行两次SHA256运算，判断运算结果值是否符合当前系统规定的难度值，如果符合则表示结题成功，该节点就获得了记账权利，将结果广播给其它的节点，其它节点可以很容易验证合法性。这就是PoW共识机制。

## 那它有什么特点呢?
它的优点很突出：算法简单，易于实现；节点之间无需交换额外的信息即可达成共识；安全性高，破坏系统需要投入极大的成本；去中心化，可允许任意节点自由加入和退出。
它的缺点也很明显：挖矿造成大量的资源浪费；共识效率低，需要等待多个确认，容易产生分叉，区块的确认共识达成的周期较长（10分钟左右），现在每秒交易量上限是7笔，不适合商业应用；PoW共识算法算力集中化，慢慢的偏离了原来的去中心化轨道。

## 使用案例
PoW共识机制目前被比特币、莱特币等公链使用。

# PBFT简单介绍
## PBFT是什么东西呢？
PBFT是实用拜占庭容错的意思，它是一种拜占庭容错的共识算法，拜占庭容错简单来说就是可容节点腐败叛变的错误。它的算法过程简单介绍一下，就是将一组相互信任的节点形成一个组，其中选出一个主节点，然后由主节点来接收客户端请求，接收到请求后则广播给其它节点，然后经过几个阶段消息交换，最后客户端如果收到超过1/3个节点的响应数据，并且响应一致，则表示这个请求达成了一致。

## 那它有什么特点呢？ 
PBFT的优点有：强一致性，不会出现分叉，一旦确认结果不会更改；共识性能高，共识的时延大约在2~5秒钟，基本达到商用实时处理的要求；共识效率高，可满足高频交易量的需求。

PBFT的缺点有：去中心化程度低，参与共识的节点不能够自由加入和退出，节点数量要提前知道，而且不能轻易变化，要提前知道其它节点；只能容许（n-1)/3个节点错误，超过这个节点数则无法达成共识；

## 使用案例
PBFT目前在Hyperledger项目代表的联盟链中使用，还有小蚁NEO公链使用了改进后的dBFT。

# PoW+PBFT混合共识详解。
## 简单介绍
从上面关于PoW和PBFT的简单介绍我们可以找到，PoW和PBFT正是两种相对的共识机制，它们的特点正好相反，而当前多数公链使用了Pow为代表的共识机制，它最大的问题是效率太低，无法满足大规模商业使用的场景，初链作为一个公链平台，就是要解决性能问题，能够满足大规模商业应用场景，这就存在矛盾了，鱼我所欲也，熊掌亦我所欲也，鱼和熊掌不可兼得。

那么初链是如何解决这个问题的呢？它采用了PoW+PBFT混合共识机制，简单来说就是将PoW和PBFT结合在一起，形成一个混合的共识机制，使得初链即可以获得PoW的去中心化特性，也可以获得PBFT的高性能特性，让鱼和熊掌和谐共处。

## 详细介绍流程和算法
两种共识机制是如何结合在一起的呢？接下来我们详细介绍一下它们的结合流程。
首先让我们一起来看一张图，也许看图就明白了。

（PoW+PBFT混合共识机制图）

也许你还没有看明白，还是简要介绍一下吧。PoW+PBFT混合共识机制实际上对应了两个区块链，一个是PBFT委员会选举链，仅仅用于选举出PBFT的委员成员节点，它是用PoW共识机制实现；一个是PBFT业务交易链，该链才用于真正的业务交易处理。

### PBFT委员会选举链
首先所有所有的节点都可以参与竞选PBFT委员会，每个节点都可以通过PoW共识算法，通过运算获得记账权，得到记账权后可以将包含自己的节点信息（节点地址和公钥等）的区块写入PBFT委员会选举链中，写入成功后的区块就有机会成为某一届PBFT委员会成员节点。


### PBFT业务交易链
从上面的PBFT委员会选举链中读取M个区块中的节点信息，要删除最近产生的某些区块，因为这些区块有可能不稳定，这样就有可能导致不一致。以这些节点组成新一届PBFT委员会成员节点，然后这些成员节点才真正参与PBFT共识机制协调，产生的业务交易区块提交给PBFT委员会成员来达成共识，PBFT委员成员选举一个主节点，由它来处理交易区块请求，它将消息广播其它PBFT委员成员，后果经过消息交互过程，返回响应给提交交易区块的节点，当超过1/3的节点响应并且结果一致，则表示该交易区块得到确认，可以写入到真正的PBFT业务交易区块链中。

# PoW+PBFT混合共识优势
对于PoW+PBF混合共识我们也有了一个初步的认识，最后我们再来回顾一下初链的混合共识的特点。它同时具备PoW的去中心化特点，支持无限节点，任意节点可自由加入和退出，这样才能真正保留公链的核心价值，使得这个公链具备公信力；它也包含了PBFT的高性能特性，可达到每秒钟1万-10万个交易，这解决了目前主流公链的关键问题所在，使得其可用于大规模商用应用。

